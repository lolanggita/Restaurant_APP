<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Delivery Management</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body{font-family:Poppins,Arial,sans-serif;background:#f6f7fb;margin:0}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  .navbar{background:#fff;border-bottom:1px solid #e5e7eb;padding:12px 0;margin-bottom:16px}
  .nav-container{display:flex;justify-content:space-between;align-items:center;max-width:1200px;margin:0 auto;padding:0 16px}
  .nav-menu a,.btn{padding:10px 14px;border-radius:10px;border:none;text-decoration:none}
  .nav-menu a{color:#374151;margin-right:6px}
  .nav-menu a.active{background:#eef2ff;color:#4338ca}
  .btn{cursor:pointer}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.05)}
  th,td{padding:12px;text-align:left;border-bottom:1px solid #e5e7eb}
  th{background:#eef2ff;color:#4338ca;font-weight:600;text-transform:uppercase}
  select{padding:4px 8px;border-radius:6px;border:1px solid #ccc;}
</style>
</head>
<body>

<nav class="navbar">
  <div class="nav-container">
    <h2>Restaurant Admin</h2>
    <div class="nav-menu">
      <a href="/">Menu</a>
      <a href="/orders.html">Orders</a>
      <a class="active" href="/delivery.html">Delivery</a>
      <button class="btn btn-secondary" onclick="logout()">Logout</button>
    </div>
  </div>
</nav>

<div class="container">
  <h1>Manajemen Delivery</h1>
  <table id="deliveryTable">
    <thead>
      <tr>
        <th>Delivery ID</th>
        <th>Order ID</th>
        <th>Status</th>
        <th>ETA</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="4">Memuat data...</td></tr>
    </tbody>
  </table>
</div>

<script>
const token = localStorage.getItem('token');
const user = JSON.parse(localStorage.getItem('user'));

function logout(){
  localStorage.removeItem('token');
  localStorage.removeItem('user');
  location.href='/login.html';
}

if(!token || !user || user.role !== "admin"){
  location.href='/login.html';
}

// daftar status yang valid
const validStatus = ["Belum Dikirim", "Dikemas", "Dikirim", "Dalam Perjalanan", "Selesai", "Dibatalkan"];

async function loadDeliveries(){
  try {
    const res = await fetch('/api/delivery/deliveries', { headers: { Authorization: 'Bearer ' + token } });
    if (!res.ok) {
      if (res.status === 401) {
        location.href = '/login.html';
        return;
      }
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    const data = await res.json();
    const tbody = document.querySelector('#deliveryTable tbody');
    if(!Array.isArray(data) || data.length === 0){
      tbody.innerHTML = '<tr><td colspan="4">Belum ada delivery</td></tr>';
      return;
    }
    tbody.innerHTML = data.map(d => `
      <tr>
        <td>${d.id}</td>
        <td>${d.order_id}</td>
        <td>
          <select onchange="updateStatus(${d.id}, this.value)">
            ${validStatus.map(s => `<option value="${s}" ${s === d.status ? 'selected' : ''}>${s}</option>`).join('')}
          </select>
        </td>
        <td>${d.eta ? new Date(d.eta).toLocaleString('id-ID') : '-'}</td>
      </tr>
    `).join('');
  } catch (error) {
    console.error('Error loading deliveries:', error);
    const tbody = document.querySelector('#deliveryTable tbody');
    tbody.innerHTML = '<tr><td colspan="4">Gagal memuat data delivery. ' + (error.message || '') + '</td></tr>';
  }
}

async function updateStatus(id, status){
  try{
    const res = await fetch(`/api/delivery/deliveries/${id}`, {
      method:'PUT',
      headers: {
        'Content-Type':'application/json',
        Authorization:'Bearer '+token
      },
      body: JSON.stringify({ status })
    });
    const data = await res.json();
    if(data.error) alert('Gagal update: '+data.error);
  } catch(e){
    alert('Terjadi kesalahan saat update status');
    console.error(e);
  }
}

document.addEventListener('DOMContentLoaded', loadDeliveries);
</script>

</body>
</html>
